<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Import Visualizer</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: sans-serif;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    body {
      background: #fafafa;
      display: flex;
      flex-direction: column;
    }
    #app {
      flex-grow: 1;
      padding: 0.75rem;
      overflow: auto;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      font-size: 0.85rem;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
      white-space: pre-wrap;
    }
    th {
      background-color: #f0f0f0;
    }
    .error {
      color: red;
      font-weight: bold;
      margin-bottom: 0.75rem;
    }
    .good-row {
      background-color: #e6ffe6;
    }
    .bad-row {
      background-color: #ffe6e6;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    function getUrlParams() {
      const urlParams = new URLSearchParams(window.location.search);
      return {
        headers: urlParams.get('headers'),
        data: urlParams.get('data')
      };
    }

    function renderTable(headers, rows, rowValidity) {
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const tbody = document.createElement('tbody');

      const trHead = document.createElement('tr');
      headers.forEach(header => {
        const th = document.createElement('th');
        th.textContent = header;
        trHead.appendChild(th);
      });
      thead.appendChild(trHead);

      rows.forEach((row, index) => {
        const tr = document.createElement('tr');
        tr.className = rowValidity[index] ? 'good-row' : 'bad-row';
        headers.forEach((_, i) => {
          const td = document.createElement('td');
          td.textContent = row[i] || '';
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });

      table.appendChild(thead);
      table.appendChild(tbody);
      return table;
    }

    function showError(msg) {
      const div = document.createElement('div');
      div.className = 'error';
      div.textContent = msg;
      return div;
    }

    function main() {
      const { headers, data } = getUrlParams();
      const app = document.getElementById('app');

      if (!headers) {
        app.appendChild(showError('Missing headers URL parameter.'));
        return;
      }

      const decodedHeaders = decodeURIComponent(headers).split(',');
      const decodedData = data ? decodeURIComponent(data) : '';

      if (!decodedData) {
        // Render empty table with headers only
        app.appendChild(renderTable(decodedHeaders, [], []));
        return;
      }

      let parsed;
      try {
        parsed = Papa.parse(decodedData, {
          skipEmptyLines: true,
          dynamicTyping: true,
          error: (err, file, inputElem, reason) => {
            console.error('PapaParse error:', err, reason);
          }
        });
      } catch (e) {
        console.error('Parsing exception:', e);
        app.appendChild(showError('Failed to parse CSV data.')); 
        return;
      }

      if (!parsed || !parsed.data || parsed.data.length === 0) {
        // Render table with headers only
        app.appendChild(renderTable(decodedHeaders, [], []));
        return;
      }

      const rowValidity = parsed.data.map(row => row.length === decodedHeaders.length);
      const hasBadRows = rowValidity.includes(false);

      if (hasBadRows) {
        app.appendChild(showError('Some rows do not match the number of headers. They are shown in red.'));
      }

      try {
        app.appendChild(renderTable(decodedHeaders, parsed.data, rowValidity));
      } catch (e) {
        console.error('Rendering error:', e);
        app.appendChild(showError('An error occurred while rendering the table.'));
      }
    }

    // Load PapaParse dynamically (used to handle CSV parsing robustly)
    const script = document.createElement('script');
    script.src = 'papaParse.js';
    script.onload = main;
    document.head.appendChild(script);
  </script>
</body>
</html>
